<div class="list-container">
  <!-- Header -->
  <div class="list-header">
    <div class="header-left">
      <h1 class="page-title">Mantenimiento</h1>
      <p class="page-subtitle">Gestiona el mantenimiento y reparaciones agrupados por propiedad</p>
    </div>
    <div class="header-right">
      <button class="btn-secondary btn-sm" (click)="expandAll()" *ngIf="groupedRecords().length > 0">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
        Expandir Todas
      </button>
      <button class="btn-secondary btn-sm" (click)="collapseAll()" *ngIf="groupedRecords().length > 0">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="18 15 12 9 6 15"></polyline>
        </svg>
        Contraer Todas
      </button>
      <button class="btn-primary" (click)="startCreating()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        Nuevo Registro
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ totalRecords() }}</div>
        <div class="stat-label">Total Registros</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon warning">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ pendingCount() }}</div>
        <div class="stat-label">Pendientes</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon info">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
          <path d="m9 12 2 2 4-4"/>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ inProcessCount() }}</div>
        <div class="stat-label">En Proceso</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon success">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ completedCount() }}</div>
        <div class="stat-label">Completados</div>
      </div>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="filters-section">
    <div class="filter-tabs">
      <button
        class="filter-tab"
        [class.active]="filterStatus() === 'ALL'"
        (click)="setStatusFilter('ALL')">
        Todos ({{ totalRecords() }})
      </button>
      <button
        class="filter-tab"
        [class.active]="filterStatus() === 'PENDIENTE'"
        (click)="setStatusFilter('PENDIENTE')">
        Pendientes ({{ pendingCount() }})
      </button>
      <button
        class="filter-tab"
        [class.active]="filterStatus() === 'EN_PROCESO'"
        (click)="setStatusFilter('EN_PROCESO')">
        En Proceso ({{ inProcessCount() }})
      </button>
      <button
        class="filter-tab"
        [class.active]="filterStatus() === 'COMPLETADO'"
        (click)="setStatusFilter('COMPLETADO')">
        Completados ({{ completedCount() }})
      </button>
    </div>

    <div class="filter-tabs" style="margin-top: 0.5rem;">
      <button
        class="filter-tab"
        [class.active]="filterType() === 'ALL'"
        (click)="setTypeFilter('ALL')">
        Todos los Tipos
      </button>
      <button
        class="filter-tab"
        [class.active]="filterType() === 'PREVENTIVO'"
        (click)="setTypeFilter('PREVENTIVO')">
        Preventivo
      </button>
      <button
        class="filter-tab"
        [class.active]="filterType() === 'CORRECTIVO'"
        (click)="setTypeFilter('CORRECTIVO')">
        Correctivo
      </button>
      <button
        class="filter-tab"
        [class.active]="filterType() === 'EMERGENCIA'"
        (click)="setTypeFilter('EMERGENCIA')">
        Emergencia
      </button>
    </div>

    <div class="search-box">
      <input
        type="text"
        class="search-input"
        placeholder="Buscar por título, código de propiedad, dirección o categoría..."
        [value]="searchTerm()"
        (input)="updateSearch($event)"
      />
    </div>
  </div>

  <!-- Grouped Maintenance Records -->
  <div class="property-groups" *ngIf="!isLoading()">
    @if (groupedRecords().length > 0) {
      @for (group of groupedRecords(); track group.propertyCode) {
        <div class="property-group">
          <!-- Property Header -->
          <div class="property-header" (click)="toggleProperty(group.propertyCode)">
            <div class="property-info">
              <div class="property-title">
                <div class="property-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                  </svg>
                </div>
                <div class="property-details">
                  <h3 class="property-code">{{ group.propertyCode }}</h3>
                  <p class="property-address">{{ group.propertyAddress }}</p>
                </div>
              </div>
              <button class="expand-button" [class.expanded]="isPropertyExpanded(group.propertyCode)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
            </div>

            <div class="property-summary">
              <div class="summary-stat">
                <span class="summary-label">Total Registros:</span>
                <span class="summary-value">{{ group.totalRecords }}</span>
              </div>
              <div class="summary-stat" *ngIf="group.pendingCount > 0">
                <span class="summary-label">Pendientes:</span>
                <span class="summary-value warning">{{ group.pendingCount }}</span>
              </div>
              <div class="summary-stat" *ngIf="group.inProcessCount > 0">
                <span class="summary-label">En Proceso:</span>
                <span class="summary-value info">{{ group.inProcessCount }}</span>
              </div>
              <div class="summary-stat" *ngIf="group.completedCount > 0">
                <span class="summary-label">Completados:</span>
                <span class="summary-value success">{{ group.completedCount }}</span>
              </div>
              <div class="summary-stat" *ngIf="group.totalEstimatedCost > 0">
                <span class="summary-label">Costo Estimado:</span>
                <span class="summary-value">{{ formatCurrency(group.totalEstimatedCost) }}</span>
              </div>
              <div class="summary-stat" *ngIf="group.totalActualCost > 0">
                <span class="summary-label">Costo Real:</span>
                <span class="summary-value">{{ formatCurrency(group.totalActualCost) }}</span>
              </div>
            </div>
          </div>

          <!-- Records Grid (Collapsible) -->
          <div class="records-grid" *ngIf="isPropertyExpanded(group.propertyCode)">
            @for (record of group.records; track record.id) {
              <app-maintenance-card
                [record]="record"
                (edit)="onEdit($event)"
                (delete)="onDelete($event)"
                (markCompleted)="onMarkCompleted($event)"
              />
            }
          </div>
        </div>
      }
    } @else {
      <div class="empty-state">
        <div class="empty-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
          </svg>
        </div>
        <h3>No se encontraron registros</h3>
        <p>No hay registros de mantenimiento que coincidan con los filtros seleccionados</p>
      </div>
    }
  </div>

  <!-- Skeleton Loaders -->
  <div class="property-groups" *ngIf="isLoading()">
    @for (i of [1,2,3]; track i) {
      <div class="property-group">
        <div class="property-header">
          <p-skeleton width="60%" height="3rem"></p-skeleton>
          <p-skeleton width="30%" height="2rem"></p-skeleton>
        </div>
      </div>
    }
  </div>

  <!-- Delete Confirmation Modal -->
  @if (showDeleteConfirm()) {
    <div class="modal-overlay" (click)="cancelDelete()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h3 class="modal-title">Confirmar Eliminación</h3>
        <p class="modal-message">
          ¿Estás seguro de que deseas eliminar este registro de mantenimiento?
          Esta acción no se puede deshacer.
        </p>
        <div class="modal-actions">
          <button class="btn-secondary" (click)="cancelDelete()">
            Cancelar
          </button>
          <button class="btn-danger" (click)="executeDelete()">
            Eliminar
          </button>
        </div>
      </div>
    </div>
  }
</div>
