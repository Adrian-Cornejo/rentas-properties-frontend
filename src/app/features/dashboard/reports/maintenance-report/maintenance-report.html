<!-- src/app/features/dashboard/reports/maintenance-report/maintenance-report.component.html -->

<div class="maintenance-report">

  <!-- ========================================
       SECCIÓN: FORMULARIO DE FILTROS
       ======================================== -->
  <div class="card filter-card">
    <div class="card-header">
      <div>
        <h3>Filtros del Reporte</h3>
        <p class="text-muted">Analiza mantenimientos y costos de tus propiedades</p>
      </div>
    </div>

    <div class="card-body">
      <form [formGroup]="filterForm" (ngSubmit)="generateReport()">
        <div class="filter-grid-extended">

          <!-- Fecha Inicio -->
          <div class="form-group">
            <label for="startDate" class="required">Fecha Inicio</label>
            <input
              type="date"
              id="startDate"
              formControlName="startDate"
              [min]="minDate()"
              [max]="maxDate()"
              class="form-control"
            />
            @if (filterForm.get('startDate')?.invalid && filterForm.get('startDate')?.touched) {
              <small class="error-message">Fecha de inicio requerida</small>
            }
          </div>

          <!-- Fecha Fin -->
          <div class="form-group">
            <label for="endDate" class="required">Fecha Fin</label>
            <input
              type="date"
              id="endDate"
              formControlName="endDate"
              [min]="minDate()"
              [max]="maxDate()"
              class="form-control"
            />
            @if (filterForm.get('endDate')?.invalid && filterForm.get('endDate')?.touched) {
              <small class="error-message">Fecha de fin requerida</small>
            }
          </div>

          <!-- Tipo de Mantenimiento -->
          <div class="form-group">
            <label for="maintenanceType">Tipo de Mantenimiento</label>
            <select id="maintenanceType" formControlName="maintenanceType" class="form-control">
              @for (type of maintenanceTypes; track type.value) {
                <option [value]="type.value">{{ type.label }}</option>
              }
            </select>
          </div>

          <!-- Estado -->
          <div class="form-group">
            <label for="status">Estado</label>
            <select id="status" formControlName="status" class="form-control">
              @for (status of maintenanceStatuses; track status.value) {
                <option [value]="status.value">{{ status.label }}</option>
              }
            </select>
          </div>

          <!-- Categoría -->
          <div class="form-group">
            <label for="category">Categoría</label>
            <select id="category" formControlName="category" class="form-control">
              @for (cat of categories; track cat.value) {
                <option [value]="cat.value">{{ cat.label }}</option>
              }
            </select>
          </div>

          <!-- Propiedad -->
          <div class="form-group">
            <label for="property">Propiedad (opcional)</label>
            <select id="property" formControlName="propertyId" class="form-control">
              <option value="">Todas las propiedades</option>
              @for (property of properties(); track property.id) {
                <option [value]="property.id">{{ property.propertyCode }} - {{ property.address }}</option>
              }
            </select>
          </div>

        </div>

        <!-- Acciones del formulario -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="clearFilters()">
            <i class="pi pi-times"></i>
            Limpiar
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="filterForm.invalid || isLoading()"
          >
            @if (isLoading()) {
              <span class="spinner"></span>
            } @else {
              <i class="pi pi-wrench"></i>
            }
            Generar Reporte
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ========================================
       SECCIÓN: MENSAJE DE ERROR
       ======================================== -->
  @if (dateRangeError()) {
    <div class="alert alert-error">
      <span class="alert-icon"><i class="pi pi-exclamation-triangle"></i></span>
      <div>
        <strong>Error en rango de fechas</strong>
        <p>{{ dateRangeError() }}</p>
      </div>
    </div>
  }

  <!-- ========================================
       SECCIÓN: LOADING
       ======================================== -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner-large"></div>
      <p>Generando reporte de mantenimientos...</p>
    </div>
  }

  <!-- ========================================
       SECCIÓN: REPORTE GENERADO
       ======================================== -->
  @if (reportData() && !isLoading()) {
    <div class="report-content">

      <!-- RESUMEN DE MANTENIMIENTOS -->
      <div class="card summary-card">
        <div class="card-header">
          <h3>Resumen de Mantenimientos</h3>
          <span class="date-range">
            {{ formatDate(reportData()!.startDate) }} - {{ formatDate(reportData()!.endDate) }}
          </span>
        </div>

        <div class="card-body">
          <div class="summary-grid">

            <!-- Total Mantenimientos -->
            <div class="summary-item">
              <div class="summary-icon total"><i class="pi pi-wrench"></i></div>
              <div class="summary-content">
                <span class="summary-label">Total Mantenimientos</span>
                <span class="summary-value">{{ reportData()!.summary.totalMaintenances }}</span>
              </div>
            </div>

            <!-- Costo Estimado -->
            <div class="summary-item">
              <div class="summary-icon cost"><i class="pi pi-wallet"></i></div>
              <div class="summary-content">
                <span class="summary-label">Costo Estimado</span>
                <span class="summary-value cost">{{ formatCurrency(reportData()!.summary.totalEstimatedCost) }}</span>
              </div>
            </div>

            <!-- Costo Real -->
            <div class="summary-item">
              <div class="summary-icon cost"><i class="pi pi-dollar"></i></div>
              <div class="summary-content">
                <span class="summary-label">Costo Real</span>
                <span class="summary-value cost">{{ formatCurrency(reportData()!.summary.totalActualCost) }}</span>
              </div>
            </div>

            <!-- Por Tipo - Preventivos -->
            <div class="summary-item">
              <div class="summary-icon preventive"><i class="pi pi-shield"></i></div>
              <div class="summary-content">
                <span class="summary-label">Preventivos</span>
                <span class="summary-value preventive">{{ reportData()!.typeBreakdown.preventive }}</span>
                <span class="summary-amount">{{ formatCurrency(reportData()!.typeBreakdown.preventiveCost) }}</span>
              </div>
            </div>

            <!-- Correctivos -->
            <div class="summary-item">
              <div class="summary-icon corrective"><i class="pi pi-hammer"></i></div>
              <div class="summary-content">
                <span class="summary-label">Correctivos</span>
                <span class="summary-value corrective">{{ reportData()!.typeBreakdown.corrective }}</span>
                <span class="summary-amount">{{ formatCurrency(reportData()!.typeBreakdown.correctiveCost) }}</span>
              </div>
            </div>

            <!-- Emergencias -->
            <div class="summary-item">
              <div class="summary-icon emergency"><i class="pi pi-bell"></i></div>
              <div class="summary-content">
                <span class="summary-label">Emergencias</span>
                <span class="summary-value emergency">{{ reportData()!.typeBreakdown.emergency }}</span>
                <span class="summary-amount">{{ formatCurrency(reportData()!.typeBreakdown.emergencyCost) }}</span>
              </div>
            </div>

            <!-- Estados -->
            <div class="summary-item">
              <div class="summary-icon completion"><i class="pi pi-check-circle"></i></div>
              <div class="summary-content">
                <span class="summary-label">Completados</span>
                <span class="summary-value completion-excellent">{{ reportData()!.summary.completed }}</span>
                <span class="summary-amount">{{ reportData()!.summary.pending }} pendientes</span>
              </div>
            </div>

            <!-- Variación de Costo -->
            <div class="summary-item">
              <div class="summary-icon variance"><i class="pi pi-chart-bar"></i></div>
              <div class="summary-content">
                <span class="summary-label">Variación de Costo</span>
                <span class="summary-value" [ngClass]="getCostVarianceClass(reportData()!.summary.costVariance)">
                  {{ reportData()!.summary.costVariance > 0 ? '+' : '' }}{{ formatPercent(reportData()!.summary.costVariance) }}
                </span>
                <span class="summary-amount">Real vs. Estimado</span>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- COSTOS POR CATEGORÍA -->
      <div class="card">
        <div class="card-header">
          <h3>Distribución de Costos por Categoría</h3>
        </div>

        <div class="card-body">
          <div class="category-chart">
            @for (category of reportData()!.categoryBreakdown; track category.category) {
              <div class="category-item">
                <div class="category-info">
                  <span class="category-name">{{ getCategoryLabel(category.category) }}</span>
                  <span class="category-count">{{ category.count }} mantenimientos</span>
                </div>
                <div class="cost-bar-container">
                  <div
                    class="cost-bar"
                    [style.width.%]="category.percentage"
                  ></div>
                </div>
                <div class="category-cost">
                  <span class="cost-value">{{ formatCurrency(category.totalCost) }}</span>
                  <span class="cost-percentage">{{ formatPercent(category.percentage) }}</span>
                </div>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- COMPARACIÓN: ESTIMADO VS REAL -->
      <div class="card">
        <div class="card-header">
          <h3>Costo Estimado vs. Costo Real por Propiedad</h3>
          <span class="badge-info"><i class="pi pi-info-circle"></i> Control de presupuesto</span>
        </div>

        <div class="card-body">
          <div class="comparison-chart">
            @for (property of reportData()!.propertyMaintenances; track property.propertyCode) {
              <div class="comparison-item">
                <div class="comparison-header">
                  <strong>{{ property.propertyCode }}</strong>
                  <span class="property-address">{{ property.address }}</span>
                </div>
                <div class="comparison-bars">
                  <div class="bar-group">
                    <span class="bar-label">Estimado</span>
                    <div class="bar-container">
                      <div class="bar estimated" [style.width.%]="50"></div>
                      <span class="bar-value">{{ formatCurrency(property.estimatedCost) }}</span>
                    </div>
                  </div>
                  <div class="bar-group">
                    <span class="bar-label">Real</span>
                    <div class="bar-container">
                      <div
                        class="bar actual"
                        [style.width.%]="(property.actualCost / property.estimatedCost * 50)"
                        [ngClass]="getCostVarianceClass(((property.actualCost - property.estimatedCost) / property.estimatedCost * 100))"
                      ></div>
                      <span class="bar-value">{{ formatCurrency(property.actualCost) }}</span>
                    </div>
                  </div>
                </div>
                <div class="variance-badge" [ngClass]="getCostVarianceClass(((property.actualCost - property.estimatedCost) / property.estimatedCost * 100))">
                  {{ ((property.actualCost - property.estimatedCost) / property.estimatedCost * 100) > 0 ? '+' : '' }}{{ formatPercent(((property.actualCost - property.estimatedCost) / property.estimatedCost * 100)) }}
                </div>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- TABLA DE DETALLE DE MANTENIMIENTOS -->
      <div class="card">
        <div class="card-header">
          <h3>Detalle de Mantenimientos por Propiedad</h3>
          <span class="badge">{{ reportData()!.propertyMaintenances.length }} propiedades</span>
        </div>

        <div class="card-body">

          <!-- Controles de tabla -->
          <div class="table-controls">
            <div class="table-info">
              Mostrando {{ (currentPage() - 1) * pageSize() + 1 }}
              a {{ Math.min(currentPage() * pageSize(), reportData()!.propertyMaintenances.length) }}
              de {{ reportData()!.propertyMaintenances.length }} registros
            </div>

            <div class="page-size-selector">
              <label>Mostrar:</label>
              <select (change)="changePageSize($event)" [value]="pageSize()">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>

          <!-- Tabla -->
          <div class="table-responsive">
            <table class="table">
              <thead>
              <tr>
                <th>Propiedad</th>
                <th>Tipo</th>
                <th>Categoría</th>
                <th>Descripción</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th class="text-right">Estimado</th>
                <th class="text-right">Real</th>
                <th class="text-center">Variación</th>
              </tr>
              </thead>
              <tbody>
                @for (maintenance of paginatedMaintenances(); track maintenance.propertyCode + maintenance.date) {
                  <tr>
                    <td>
                      <div class="property-cell">
                        <strong>{{ maintenance.propertyCode }}</strong>
                        <span class="property-address">{{ maintenance.propertyAddress }}</span>
                      </div>
                    </td>
                    <td>
                      <span class="type-badge" [ngClass]="getTypeClass(maintenance.maintenanceType)">
                        {{ getTypeLabel(maintenance.maintenanceType) }}
                      </span>
                    </td>
                    <td>
                      <span class="category-badge">{{ getCategoryLabel(maintenance.category) }}</span>
                    </td>
                    <td class="description-cell">{{ maintenance.description }}</td>
                    <td>{{ formatDate(maintenance.date) }}</td>
                    <td>
                      <span class="status-badge" [ngClass]="getStatusClass(maintenance.status)">
                        {{ getStatusLabel(maintenance.status) }}
                      </span>
                    </td>
                    <td class="text-right">{{ formatCurrency(maintenance.estimatedCost) }}</td>
                    <td class="text-right">{{ formatCurrency(maintenance.actualCost) }}</td>
                    <td class="text-center">
                      <span class="variance-badge" [ngClass]="getCostVarianceClass(maintenance.variance)">
                        {{ maintenance.variance > 0 ? '+' : '' }}{{ formatPercent(maintenance.variance) }}
                      </span>
                    </td>
                  </tr>
                } @empty {
                  <tr>
                    <td colspan="9" class="text-center empty-state">
                      <div class="empty-icon"><i class="pi pi-inbox"></i></div>
                      <p>No hay datos disponibles</p>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Paginación -->
          @if (totalPages() > 1) {
            <div class="pagination">
              <button
                class="pagination-btn"
                (click)="previousPage()"
                [disabled]="currentPage() === 1"
              >
                ← Anterior
              </button>

              @for (page of getPageNumbers(); track $index) {
                @if (page === -1) {
                  <span class="pagination-ellipsis">...</span>
                } @else {
                  <button
                    class="pagination-btn"
                    [class.active]="currentPage() === page"
                    (click)="goToPage(page)"
                  >
                    {{ page }}
                  </button>
                }
              }

              <button
                class="pagination-btn"
                (click)="nextPage()"
                [disabled]="currentPage() === totalPages()"
              >
                Siguiente →
              </button>
            </div>
          }

        </div>
      </div>

      <!-- EXPORTACIÓN -->
      <div class="card export-card">
        <div class="card-body">
          <div class="export-actions">
            <div class="export-info">
              <span class="icon"><i class="pi pi-info-circle"></i></span>
              <span>Exporta el reporte en diferentes formatos</span>
            </div>

            <div class="export-buttons">
              @if (canExportCsv()) {
                <button class="btn btn-secondary" (click)="exportCsv()">
                  <i class="pi pi-file"></i>
                  Exportar CSV
                </button>
              }

              @if (canExportPdf()) {
                <button
                  class="btn btn-danger"
                  (click)="exportPdf()"
                  [disabled]="isExporting()"
                >
                  @if (isExporting()) {
                    <span class="spinner"></span>
                  } @else {
                    <i class="pi pi-file-pdf"></i>
                  }
                  Exportar PDF
                </button>
              } @else {
                <button class="btn btn-danger btn-disabled" disabled title="Actualiza tu plan">
                  <i class="pi pi-lock"></i>
                  Exportar PDF
                </button>
              }

              @if (canExportExcel()) {
                <button
                  class="btn btn-success"
                  (click)="exportExcel()"
                  [disabled]="isExporting()"
                >
                  @if (isExporting()) {
                    <span class="spinner"></span>
                  } @else {
                    <i class="pi pi-file-excel"></i>
                  }
                  Exportar Excel
                </button>
              } @else {
                <button class="btn btn-success btn-disabled" disabled title="Actualiza tu plan">
                  <i class="pi pi-lock"></i>
                  Exportar Excel
                </button>
              }
            </div>
          </div>
        </div>
      </div>

    </div>
  }

</div>
