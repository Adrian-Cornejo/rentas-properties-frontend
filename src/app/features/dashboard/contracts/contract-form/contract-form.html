<div class="form-container">
  <!-- Header -->
  <div class="form-header">
    <div class="header-left">
      <button class="btn-back" (click)="cancel()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="m15 18-6-6 6-6"/>
        </svg>
      </button>
      <div class="header-title-section">
        <h1 class="form-title">{{ isEditing() ? 'Editar Contrato' : 'Nuevo Contrato' }}</h1>
        <p class="form-subtitle">{{ isEditing() ? 'Actualiza la información del contrato' : 'Registra un nuevo contrato de arrendamiento' }}</p>
      </div>
    </div>
  </div>

  <!-- Form Content with Tabs -->
  <div class="form-content">
    <div class="tabs">
      <button
        type="button"
        class="tab-button"
        [class.active]="activeTab() === 'basic'"
        (click)="selectTab('basic')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/>
          <rect x="2" y="14" width="20" height="8" rx="2" ry="2"/>
        </svg>
        <span class="tab-text">Información Básica</span>
      </button>

      <button
        type="button"
        class="tab-button"
        [class.active]="activeTab() === 'tenants'"
        (click)="selectTab('tenants')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        <span class="tab-text">Inquilinos</span>
      </button>

      <button
        type="button"
        class="tab-button"
        [class.active]="activeTab() === 'payments'"
        (click)="selectTab('payments')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" x2="12" y1="2" y2="22"/>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
        </svg>
        <span class="tab-text">Pagos y Depósito</span>
      </button>

      <button
        type="button"
        class="tab-button"
        [class.active]="activeTab() === 'documents'"
        [class.disabled]="!planAllowsImages()"
        (click)="selectTab('documents')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
          <polyline points="14 2 14 8 20 8"/>
        </svg>
        <span class="tab-text">Documentos</span>
        @if (!planAllowsImages()) {
          <i class="pi pi-lock tab-lock-icon"></i>
        }
      </button>
    </div>

    <form [formGroup]="contractForm" (ngSubmit)="onSubmit()">
      <!-- Tab 1: Basic Information -->
      <div class="tab-content" *ngIf="activeTab() === 'basic'">
        <div class="form-row">
          <div class="form-group full-width">
            <label for="propertyId">Propiedad *</label>
            <p-select
              inputId="propertyId"
              formControlName="propertyId"
              [options]="propertyOptions()"
              optionLabel="label"
              optionValue="value"
              placeholder="Selecciona una propiedad"
              styleClass="custom-select"
              [filter]="true"
              filterBy="value,label"
              [style]="{'width': '100%'}">
            </p-select>
            <span class="error-message" *ngIf="contractForm.get('propertyId')?.invalid && contractForm.get('propertyId')?.touched">
              La propiedad es requerida
            </span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="startDate">Fecha de Inicio *</label>
            <p-datepicker
              inputId="startDate"
              formControlName="startDate"
              dateFormat="dd/mm/yy"
              placeholder="Selecciona una fecha"
              styleClass="custom-datepicker"
              [showIcon]="true"
              [iconDisplay]="'input'"
              [style]="{'width': '100%'}">
            </p-datepicker>
            <span class="error-message" *ngIf="contractForm.get('startDate')?.invalid && contractForm.get('startDate')?.touched">
                La fecha de inicio es requerida
            </span>
          </div>

          <div class="form-group">
            <label for="endDate">Fecha de Fin *</label>
            <p-datepicker
              inputId="endDate"
              formControlName="endDate"
              dateFormat="dd/mm/yy"
              placeholder="Selecciona una fecha"
              styleClass="custom-datepicker"
              [showIcon]="true"
              [iconDisplay]="'input'"
              [style]="{'width': '100%'}">
            </p-datepicker>
            <span class="error-message" *ngIf="contractForm.get('endDate')?.invalid && contractForm.get('endDate')?.touched">
               La fecha de fin es requerida
            </span>
          </div>

          <div class="form-group">
            <label for="signedDate">Fecha de Firma</label>
            <p-datepicker
              inputId="signedDate"
              formControlName="signedDate"
              dateFormat="dd/mm/yy"
              placeholder="Selecciona una fecha"
              styleClass="custom-datepicker"
              [showIcon]="true"
              [iconDisplay]="'input'"
              [style]="{'width': '100%'}">
            </p-datepicker>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="monthlyRent">Renta Mensual *</label>
            <input
              id="monthlyRent"
              type="number"
              formControlName="monthlyRent"
              readonly
            />
          </div>

          <div class="form-group">
            <label for="waterFee">Costo de Agua *</label>
            <input
              id="waterFee"
              type="number"
              formControlName="waterFee"
              readonly
            />
          </div>
        </div>
      </div>

      <!-- Tab 2: Tenants -->
      <div class="tab-content" *ngIf="activeTab() === 'tenants'">
        <!-- Mensaje informativo en modo edición -->
        <div class="info-message" *ngIf="isEditing()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4"/>
            <path d="M12 8h.01"/>
          </svg>
          <div class="info-content">
            <h4>Inquilinos del Contrato</h4>
            <p>Los inquilinos no pueden modificarse una vez creado el contrato. Si necesitas hacer cambios, contacta al administrador del sistema.</p>
          </div>
        </div>

        <!-- Contenido normal en modo creación -->
        <div *ngIf="!isEditing()">
          <div class="section-info">
            <p>Agrega los inquilinos que habitarán la propiedad. Debe haber al menos uno y exactamente uno debe ser el principal.</p>
          </div>
        </div>

        <!-- Lista de inquilinos (visible siempre) -->
        <div class="tenants-list" *ngIf="hasAssignedTenants()">
          <div class="tenant-item" *ngFor="let assignment of assignedTenants()">
            <div class="tenant-header">
              <div class="tenant-name">{{ getTenantName(assignment.tenantId) }}</div>
              <!-- Solo mostrar botón de eliminar en modo creación -->
              <button
                *ngIf="!isEditing()"
                type="button"
                class="btn-remove"
                (click)="removeTenant(assignment.tenantId)">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 6 6 18M6 6l12 12"/>
                </svg>
              </button>
            </div>

            <div class="tenant-details">
              <div class="form-group">
                <label class="checkbox-label" [class.disabled]="isEditing()">
                  <input
                    type="radio"
                    name="primaryTenant"
                    [checked]="assignment.isPrimary"
                    (change)="!isEditing() && setPrimaryTenant(assignment.tenantId)"
                    [disabled]="isEditing()"
                  />
                  <span>{{ assignment.isPrimary ? 'Inquilino Principal' : 'Inquilino Adicional' }}</span>
                </label>
              </div>

              <div class="form-group" *ngIf="assignment.relationship">
                <label class="detail-label">Relación:</label>
                <span class="detail-value">{{ assignment.relationship || 'No especificada' }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Estado vacío -->
        <div class="empty-tenant-state" *ngIf="!hasAssignedTenants() && !isEditing()">
          <p>No hay inquilinos agregados</p>
        </div>

        <!-- Select para agregar inquilinos - SOLO EN MODO CREACIÓN -->
        <div class="form-row" *ngIf="!isEditing()">
          <div class="form-group full-width">
            <label for="addTenant">Agregar Inquilino</label>
            <p-select
              inputId="addTenant"
              [options]="tenantOptions()"
              optionLabel="label"
              optionValue="value"
              placeholder="Selecciona un inquilino"
              styleClass="custom-select"
              [filter]="true" filterBy="value,label"
              [style]="{'width': '100%'}"
              (onChange)="addTenantFromSelect($event.value)">
            </p-select>
          </div>
        </div>

        <!-- Validaciones - SOLO EN MODO CREACIÓN -->
        <div *ngIf="!isEditing()">
          <div class="validation-alert" *ngIf="!hasAssignedTenants()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
              <path d="M12 9v4"/>
              <path d="M12 17h.01"/>
            </svg>
            <span>Debe agregar al menos un inquilino</span>
          </div>

          <div class="validation-alert" *ngIf="hasAssignedTenants() && !hasPrimaryTenant()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
              <path d="M12 9v4"/>
              <path d="M12 17h.01"/>
            </svg>
            <span>Exactamente un inquilino debe ser marcado como principal</span>
          </div>
        </div>
      </div>

      <!-- Tab 3: Payments and Deposit -->
      <div class="tab-content" *ngIf="activeTab() === 'payments'">
        <div class="form-row">
          <div class="form-group">
            <label for="advancePayment">Monto de Adelanto</label>
            <input
              id="advancePayment"
              type="number"
              formControlName="advancePayment"
              placeholder="0.00"
              min="0"
              step="0.01"
            />
          </div>

          <div class="form-group">
            <label for="depositAmount">Monto de Depósito *</label>
            <input
              id="depositAmount"
              type="number"
              formControlName="depositAmount"
              placeholder="0.00"
              min="0"
              step="0.01"
            />
            <span class="error-message" *ngIf="contractForm.get('depositAmount')?.invalid && contractForm.get('depositAmount')?.touched">
              El depósito es requerido y debe ser mayor a 0
            </span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label class="checkbox-label">
              <input
                type="checkbox"
                formControlName="depositPaid"
              />
              <span>Depósito pagado</span>
            </label>
          </div>
        </div>

        <div class="form-row" *ngIf="!contractForm.get('depositPaid')?.value">
          <div class="form-group full-width">
            <label for="depositPaymentDeadline">Fecha Límite para Pago de Depósito *</label>
            <p-datepicker
              inputId="depositPaymentDeadline"
              formControlName="depositPaymentDeadline"
              dateFormat="dd/mm/yy"
              placeholder="Selecciona una fecha"
              styleClass="custom-datepicker"
              [showIcon]="true"
              [iconDisplay]="'input'"
              [style]="{'width': '100%'}">
            </p-datepicker>
            <span class="error-message" *ngIf="contractForm.get('depositPaymentDeadline')?.invalid && contractForm.get('depositPaymentDeadline')?.touched">
                La fecha límite es requerida si el depósito no está pagado
            </span>
          </div>
        </div>
      </div>

      <!-- Tab 4: Documents -->
      <div class="tab-content" *ngIf="activeTab() === 'documents'">

        <!-- Si el plan NO permite imágenes -->
        @if (!planAllowsImages()) {
          <div class="feature-locked-full">
            <i class="pi pi-lock"></i>
            <h3>Funcionalidad Bloqueada</h3>
            <p>Tu plan <strong>{{ getPlanName() }}</strong> no incluye la funcionalidad de subir documentos.</p>
            <p class="upgrade-hint">Mejora tu plan para desbloquear esta característica.</p>
          </div>
        }

        <!-- Si el plan SÍ permite imágenes -->
        @if (planAllowsImages()) {
          <div class="upload-section">
            <label>Contrato PDF</label>

            <div class="upload-area" *ngIf="!contractDocumentUrl()">
              <input
                type="file"
                accept="application/pdf"
                id="documentUpload"
                class="file-input"
                (change)="onDocumentSelect($event)"
                #fileInput
              />
              <label for="documentUpload" class="upload-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" x2="12" y1="3" y2="15"/>
                </svg>
                <span>{{ isUploadingDocument() ? 'Subiendo documento...' : 'Clic para seleccionar archivo PDF' }}</span>
                <small>Máximo 10MB</small>
              </label>
            </div>

            <div class="document-preview" *ngIf="contractDocumentUrl()">
              <div class="document-info">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                  <polyline points="14 2 14 8 20 8"/>
                </svg>
                <div class="document-details">
                  <span class="document-name">Contrato.pdf</span>
                  <a [href]="contractDocumentUrl()" target="_blank" class="document-link">Ver documento</a>
                </div>
              </div>
              <button
                type="button"
                class="btn btn-danger-outline"
                >
                Eliminar
              </button>
            </div>
          </div>

          <div class="notes-section">
            <label for="notes">Notas</label>
            <div class="textarea-wrapper">
              <textarea
                id="notes"
                formControlName="notes"
                rows="5"
                maxlength="500"
                placeholder="Escribe notas adicionales sobre este contrato..."></textarea>
              <div class="char-counter">
                {{ getCharCount() }} / 500 caracteres
              </div>
            </div>
          </div>
        }
      </div>
    </form>
  </div>

  <!-- Form Actions -->
  <div class="form-actions">
    <button type="button" class="btn btn-secondary" (click)="cancel()">
      Cancelar
    </button>
    <button type="submit" class="btn btn-primary" [disabled]="!canSubmit()" (click)="onSubmit()">
      {{ isSaving() ? 'Guardando...' : (isEditing() ? 'Actualizar' : 'Crear') }}
    </button>
  </div>
</div>
